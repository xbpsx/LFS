Программа Xscrabble Мэтта Чепмена показалась мне интересной, так как я являюсь страстным игроком в Scrabble™. Я скачал ее, распаковал и попытался собрать, следуя процедуре из файла **README**:

```text
xmkmf
make Makefiles
make includes
make
```

Конечно же, это не сработало...

```text
gcc -o xscrab -O2 -O -L/usr/X11R6/lib 
init.o xinit.o misc.o moves.o cmove.o main.o xutils.o mess.o popup.o
widgets.o display.o user.o CircPerc.o
-lXaw -lXmu -lXExExt -lXext -lX11 -lXt -lSM -lICE -lXExExt -lXext -lX11
-lXpm -L../Xc -lXc

BarGraf.o(.text+0xe7): undefined reference to `XtAddConverter'
BarGraf.o(.text+0x29a): undefined reference to `XSetClipMask'
BarGraf.o(.text+0x2ff): undefined reference to `XSetClipRectangles'
BarGraf.o(.text+0x375): undefined reference to `XDrawString'
BarGraf.o(.text+0x3e7): undefined reference to `XDrawLine'
etc.
etc.
etc...
```

Я спросил об этом в телеконференции comp.os.linux.x, и кто-то любезно указал, что, по-видимому, библиотеки `Xt`, `Xaw`, `Xmu` и `X11` не находятся на этапе компоновки. Хмм...

Было два основных Makefile, и тот, что в каталоге `src`, привлек мое внимание. Одна строка в Makefile определяла LOCAL_LIBS как: `LOCAL_LIBS = $(XAWLIB) $(XMULIB) $(XTOOLLIB) $(XLIB)`. Здесь были ссылки на библиотеки, которые не находил компоновщик.

Ища следующую ссылку на LOCAL_LIBS, я увидел в строке 495 этого Makefile:

```text
$(CCLINK) -o $@ $(LDOPTIONS) $(OBJS) $(LOCAL_LIBS) $(LDLIBS) $(EXTRA_LOAD_FLAGS)
```

А что такое LDLIBS?

```text
LDLIBS = $(LDPOSTLIB) $(THREADS_LIBS) $(SYS_LIBRARIES) $(EXTRA_LIBRARIES)
```

SYS_LIBRARIES были:

```text
SYS_LIBRARIES = -lXpm -L../Xc -lXc
```

Да! Вот они, отсутствующие библиотеки.

Возможно, компоновщику нужно было видеть LDLIBS перед LOCAL_LIBS... Итак, первое, что нужно попробовать, — изменить Makefile, переставив $(LOCAL_LIBS) и $(LDLIBS) в строке 495, чтобы теперь она читалась как:

```text
$(CCLINK) -o $@ $(LDOPTIONS) $(OBJS) $(LDLIBS) $(LOCAL_LIBS) $(EXTRA_LOAD_FLAGS)
                          ^^^^^^^^^^^^^^^^^^^^^^^
```

Я попробовал снова запустить make с указанным изменением, и, о чудо, на этот раз это сработало. Конечно, Xscrabble все еще требовала некоторой тонкой настройки и правок, таких как переименование словаря и комментирование некоторых операторов assert в одном из исходных файлов, но с тех пор она доставила мне много часов удовольствия.

---
[[Навигация по книге «Building and Installing Software Packages for Linux»]]

### Зачем вам это нужно? Развёрнутые пояснения

Этот пример — **практическая иллюстрация всего, о чем говорилось в руководстве**. Это не просто рассказ об успешной сборке, а демонстрация реального процесса решения проблемы, с которым вы обязательно столкнетесь при сборке LFS и в дальнейшей работе с Linux.

**1. Типичный сценарий: "Конечно, это не сработало..."**

- Автор с иронией отмечает, что сборка не прошла гладко. Это нормально! Опытные системные администраторы знают, что проблемы — это часть процесса.

- **Для LFS:** Будьте готовы к тому, что что-то может пойти не так. Ключ к успеху — не паниковать, а методично искать решение.


**2. Анализ ошибок компоновщика.**

- Ошибки вида "undefined reference to `XtAddConverter'" указывают, что компоновщик не может найти реализации функций из библиотек X11.

- **Важный момент:** Компиляция (создание `.o` файлов) прошла успешно, проблема возникла на этапе линковки, когда отдельные объектные файлы собираются в единый исполняемый файл вместе с библиотеками.


**3. Процесс отладки — пошаговый разбор:**

1. **Поиск помощи:** Автор обратился в телеконференцию (аналог современных форумов). Сегодня вы бы искали в Google, Stack Overflow или специализированных форумах.

2. **Гипотеза:** Ему подсказали, что библиотеки не находятся. Это стандартная проблема.

3. **Исследование Makefile:** Вместо слепого тыка автор начал изучать `Makefile`. Это критически важный навык. Он нашел:

    - `LOCAL_LIBS`, которые содержат основные библиотеки X11 (`-lXaw -lXmu -lXt -lX11`).
    
    - `LDLIBS`, которые содержат дополнительные библиотеки (`-lXpm -L../Xc -lXc`).

4. **Понимание порядка линковки:** Компоновщик (`ld`) обрабатывает библиотеки **в порядке их указания**. Если библиотека `A` зависит от библиотеки `B`, то `A` должна быть указана перед `B`. Возможно, библиотеки в `LDLIBS` зависели от тех, что в `LOCAL_LIBS`, поэтому их нужно было поменять местами.

5. **Эксперимент:** Автор изменил порядок и пересобрал. Это сработало!


**4. Почему порядок библиотек важен?**

- Компоновщик в Unix (и в Linux) работает по принципу **"один проход, слева направо"**. Когда он встречает библиотеку, он извлекает из нее только те объектные файлы, которые разрешают _текущие_ неопределенные символы.

- **Пример:** Если у вас есть `-lXpm -lX11`, и код требует функции из `X11`, которая используется в `Xpm`, то при таком порядке `Xpm` будет обработана первой, и функция из `X11` останется неопределенной. Если поменять порядок на `-lX11 -lXpm`, то сначала будет обработана `X11`, и тогда `Xpm` сможет найти нужные функции.

- **Для LFS:** Вы столкнетесь с этим при сборке некоторых пакетов. В книге LFS обычно даются правильные флаги, но если вы отклонитесь от инструкций или добавите свои пакеты, это знание будет необходимо.


**5. Дополнительная настройка после сборки.**

- Автору пришлось переименовать словарь и закомментировать `assert`. Это типично для старых программ, которые могут требовать адаптации к современным системам.

- **Для LFS:** В процессе сборки LFS вы будете применять **патчи** (patch) к исходному коду некоторых пакетов. Эти патчи как раз содержат подобные правки: исправления для сборки с новыми библиотеками, изменения путей и т.д.


**6. Заключительное замечание о rpm.**

- Автор отмечает, что теперь есть rpm-пакет, который устанавливается без проблем. Это возвращает нас к главе 4: бинарные пакеты удобнее, но сборка из исходников дает понимание и контроль.


**Практические уроки для LFS:**

1. **Не бойтесь ошибок.** Они — возможность чему-то научиться.

2. **Учитесь читать вывод компилятора и компоновщика.** Сообщения об ошибках содержат ключ к решению.

3. **Изучайте Makefile.** Понимание того, как организована сборка, — мощный инструмент.

4. **Понимайте порядок линковки библиотек.** Это частая причина проблем.

5. **Будьте готовы к дополнительной настройке.** Сборка — это только полдела; иногда нужны дополнительные правки конфигурации.

6. **Ищите помощь, но сначала попробуйте разобраться сами.** Попытка решить проблему самостоятельно даст больше опыта, чем простое копирование готового решения.


**Итог этого примера:**  
Это прекрасная демонстрация того, как **системное мышление** и **методологический подход** позволяют решить, казалось бы, сложную проблему. Вы не просто выполняете инструкции, а понимаете, как работает система сборки, и можете вмешаться в процесс, чтобы исправить его. Именно эти навыки позволят вам успешно пройти через сборку LFS, где вам предстоит собрать не одну программу, а целую операционную систему, и каждая может преподнести свои сюрпризы.