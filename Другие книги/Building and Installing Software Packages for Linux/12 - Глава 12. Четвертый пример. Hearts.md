
Вот старая-добрая игра "Сердца" (Hearts), написанная для UNIX Бобом Анкени в 80-х, переработанная в 1992 году Майком Янгом и в настоящее время поддерживаемая Джонатаном Бэджером. Ее предшественником была еще более старая программа на Паскале от Дона Бэкуса из Oregon Software, позже обновленная Джеффом Хеммерлингом. Первоначально предназначенная для многопользовательской игры по сети, она также хорошо работает в однопользовательском режиме против компьютерных оппонентов. Графика хорошая, хотя в игре отсутствуют сложные функции, и компьютерные игроки не особенно сильны. Тем не менее, кажется, это единственная приличная игра "Сердца", доступная для UNIX и Linux-машин даже в наше время.

Из-за своего возраста и родословной этот пакет особенно сложно собрать на системе Linux. Это требует решения длинной и запутанной серии головоломок. Это упражнение на терпение и решительность.

Перед началом убедитесь, что у вас установлены библиотеки `motif` или `lesstif`.

```text
xmkmf
make
```

```text
client.c: In function `read_card':
client.c:430: `_tty' undeclared (first use in this function)
client.c:430: (Each undeclared identifier is reported only once
client.c:430: for each function it appears in.)
client.c: In function `scan':
client.c:685: `_tty' undeclared (first use in this function)
make: *** [client.o] Error 1
```

Вот проблемные места в файле `client.c`:

```c
#ifndef SYSV
        (buf[2] != _tty.sg_erase) && (buf[2] != _tty.sg_kill)) {
#else
        (buf[2] != CERASE) && (buf[2] != CKILL)) {
#endif
```

В `client.c` добавьте

```c
#define SYSV
```

на строку 39. Это обойдет ссылку на `_tty`.

```bash
make
```

```bash
client.c:41: sys/termio.h: No such file or directory
make: *** [client.o] Error 1
```

Заголовочный файл `termio.h` находится в каталоге `/usr/include` в Linux, а не в `/usr/include/sys`, как это было на старых UNIX-машинах. Поэтому измените строку 41 в `client.c` c

```c
#include <sys/termio.h>
```

на

```c
#include <termio.h>
```

```bash
make
```

```bash
gcc -o hearts -g      -L/usr/X11R6/lib client.o hearts.o select.o
connect.o sockio.o start_dist.o  -lcurses -ltermlib       
/usr/bin/ld: cannot open -ltermlib: No such file or directory
collect2: ld returned 1 exit status
make: *** [hearts] Error 1
```

Современные дистрибутивы Linux используют базу данных `terminfo` и/или` termcap`, а не устаревшую `termlib`.

Отредактируйте `Makefile`.

Строка 655:

```makefile
CURSES_LIBRARIES = -lcurses -ltermlib
```

меняем на:

```makefile
CURSES_LIBRARIES = -lcurses -ltermcap
```

```bash
make
```

```bash
gcc -o xmhearts -g      -L/usr/X11R6/lib xmclient.o hearts.o select.o
connect.o sockio.o start_dist.o gfx.o  -lXm_s -lXt -lSM -lICE -lXext -lX11
-lPW       
/usr/bin/ld: cannot open -lXm_s: No such file or directory
collect2: ld returned 1 exit status
```

Основная библиотека `lesstif` называется `libXm`, а не `libXm_s`. Поэтому отредактируйте `Makefile`.

В строке 653:

```makefile
XMLIB = -lXm_s $(XTOOLLIB) $(XLIB) -lPW
```

меняем на:

```makefile
XMLIB = -lXm $(XTOOLLIB) $(XLIB) -lPW
```

```bash
make
```

```bash
gcc -o xmhearts -g      -L/usr/X11R6/lib xmclient.o hearts.o select.o
connect.o sockio.o start_dist.o gfx.o  -lXm -lXt -lSM -lICE -lXext -lX11 -lPW       
/usr/bin/ld: cannot open -lPW: No such file or directory
collect2: ld returned 1 exit status
make: *** [xmhearts] Error 1
```

Проверим обычные подозреваемые.

Библиотеки PW нет. Отредактируйте `Makefile`.

Строка 653:

```makefile
XMLIB = -lXm $(XTOOLLIB) $(XLIB) -lPW
```

меняем на:

```makefile
XMLIB = -lXm $(XTOOLLIB) $(XLIB) -lPEX5
```

(Библиотека `PEX5` ближе всего к PW.)

```bash
make
```

```bash
rm -f xmhearts
gcc -o xmhearts -g      -L/usr/X11R6/lib xmclient.o hearts.o select.o
connect.o sockio.o start_dist.o gfx.o  -lXm -lXt -lSM -lICE -lXext -lX11 -lPEX5       
```

Наконец, `make` завершается успешно (ура!).

**Установка:**

От имени root:

```text
[root@localhost hearts]# make install
install -c -s  hearts /usr/X11R6/bin/hearts
install -c -s  xmhearts /usr/X11R6/bin/xmhearts
install -c -s  xawhearts /usr/X11R6/bin/xawhearts
install in . done
```

**Пробный запуск:**

```bash
rehash
```

(Мы используем оболочку tcsh.)

```text
xmhearts
```

```text
localhost:~/% xmhearts
Can't invoke distributor!
```

Из файла **README** в пакете hearts:

```text
Put heartsd, hearts_dist, and hearts.instr in the HEARTSLIB
directory defined in local.h and make them world-accessible.
```

Из файла `local.h`:

```c
/* where the distributor, dealer and instructions live */

#define HEARTSLIB "/usr/local/lib/hearts"
```

Это классический случай "читайте инструкцию" (RTFM).

От имени root:

```bash
cd /usr/local/lib
mkdir hearts
cd !$
```

Скопируйте файлы дистрибьютора в этот каталог:

```bash
cp /home/username/hearts/heartsd .
cp /home/username/hearts/hearts_dist .
cp /home/username/hearts/hearts.instr .
```

Попробуйте еще раз запустить игру.

```text
xmhearts
```

Иногда она работает, но чаще всего вылетает с сообщением `dealer died!`.

"Дистрибьютор" и "дилер" сканируют аппаратные порты. Поэтому можно предположить, что этим программам нужны привилегии пользователя root.

Попробуйте, от имени root:

```bash
chmod u+s /usr/local/lib/heartsd
chmod u+s /usr/local/lib/hearts_dist
```

(Обратите внимание, что, как обсуждалось ранее, suid-бинарники могут создавать дыры в безопасности.)

```text
xmhearts
```

Наконец-то все работает!


---
[[Навигация по книге «Building and Installing Software Packages for Linux»]]


### Зачем вам это нужно? Развёрнутые пояснения

Этот пример — **кульминация всего руководства**. Он демонстрирует _реальный_ процесс сборки сложного старого пакета, который требует множества исправлений и глубокого понимания системы. Это тот самый опыт, который подготовит вас к LFS, где вы будете сталкиваться с подобными проблемами, но в гораздо большем масштабе.

**1. Последовательное решение проблем (шаг за шагом).**  
Автор показывает методологический подход: каждая ошибка анализируется и исправляется, прежде чем перейти к следующей. Это ключевой навык для сборки LFS.

**Основные исправления и их причины:**

**2. Исправление устаревшего кода (определение SYSV).**

- Программа использует устаревшую структуру `_tty`, характерную для старых UNIX (BSD). В современных системах (особенно Linux) используется стандарт POSIX/SYSV.

- Определение макроса `SYSV` переключает код на использование стандартных констант `CERASE` и `CKILL`.


**3. Исправление путей к заголовочным файлам.**

- Старые UNIX системы размещали `termio.h` в `/usr/include/sys/`. В Linux он находится в `/usr/include/`.

- Это типичная проблема переносимости между разными UNIX-подобными системами.


**4. Замена устаревших библиотек.**

- `-ltermlib` → `-ltermcap`: переход с устаревшей `termlib` на `termcap` (более современную в то время, сейчас используется terminfo).

- `-lXm_s` → `-lXm`: разные реализации библиотеки Motif. Lesstif (свободная реализация Motif) предоставляет библиотеку `libXm`.

- `-lPW` → `-lPEX5`: библиотека PW (Plane Widgets) устарела; `PEX5` (3D-графика) была ближайшей заменой.
    

**5. Установка и настройка после сборки.**

- Даже после успешной сборки программа требует дополнительной настройки:

    1. Создание каталога для данных игры (`/usr/local/lib/hearts`).
    
    2. Копирование вспомогательных файлов.
    
    3. Установка битов `setuid` для программ, требующих привилегий root (опасно с точки зрения безопасности!).


**6. Проблемы безопасности (setuid).**

- Автор честно предупреждает об опасности setuid-программ. В современных системах такой подход считается рискованным.

- **Для LFS:** Вы будете настраивать права доступа для системных программ, но нужно делать это осознанно.


**Как это применимо к LFS:**

1. **Патчи:** Большинство исправлений, которые автор делает вручную, в LFS будут предоставлены в виде готовых патчей. Но понимание _почему_ эти патчи нужны, сделает вас более компетентным системным администратором.

2. **Последовательность сборки:** В LFS пакеты собираются в строгом порядке. Если что-то пойдет не так, вам нужно будет уметь анализировать ошибки и вносить исправления (хотя в LFS большинство проблем уже решены сообществом).

3. **Работа с устаревшим кодом:** Некоторые пакеты в LFS могут быть довольно старыми и требовать адаптации к современным системам. Умение читать и понимать подобные исправления критически важно.

4. **Понимание зависимостей:** В примере видно, как автор ищет замену отсутствующим библиотекам. В LFS все зависимости тщательно продуманы, но если вы решите добавить свои пакеты, этот навык пригодится.

**Практические уроки:**

1. **Терпение:** Сборка старого ПО может быть мучительной, но каждая решенная проблема делает вас сильнее.

2. **Внимательность к деталям:** Небольшая ошибка в коде или `Makefile` может привести к сбою сборки.

3. **Глубокое понимание системы:** Чтобы исправить подобные проблемы, нужно понимать, как организованы заголовочные файлы, библиотеки и системные вызовы.

4. **Документация:** Всегда читайте README, INSTALL и другую документацию. Часто там есть ключ к решению проблем.
    

**Итог всей книги:**

Вы прошли путь от базовых понятий (распаковка тарболов) до продвинутых техник (отладка и исправление исходного кода). Вы научились:

- Работать с системами сборки (make, configure, xmkmf)

- Решать проблемы с зависимостями библиотек

- Анализировать ошибки компиляции и линковки

- Вносить минимальные изменения в исходный код для адаптации к современным системам

- Интегрировать программное обеспечение в систему (установка, настройка, документация)


**Теперь вы готовы к LFS.**

В LFS вы примените все эти навыки в гораздо большем масштабе. Вместо сборки отдельных программ вы будете собирать целую операционную систему из сотен взаимозависимых пакетов. Каждый пакет в LFS потребует внимания к деталям и понимания процесса сборки.

Помните главный урок этого руководства: **не существует "волшебной" кнопки "Установить"**. Каждая программа, которую вы используете, кем-то собрана из исходного кода. Теперь вы знаете, как это делается, и можете делать это сами.

Удачи в создании вашей собственной системы Linux From Scratch!