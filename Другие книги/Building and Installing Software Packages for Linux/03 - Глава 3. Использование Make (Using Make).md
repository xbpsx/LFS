`Makefile` — это ключ к процессу сборки. В своей простейшей форме `Makefile` представляет собой скрипт для компиляции или сборки «бинарных файлов» — исполняемых частей пакета. `Makefile` также может предоставлять способ обновления программного пакета без необходимости перекомпилировать каждый исходный файл, но это уже другая история (или другая статья).

В какой-то момент `Makefile` запускает `cc` или `gcc`. На самом деле это препроцессор, компилятор C (или C++) и компоновщик, вызываемые в указанном порядке. Этот процесс преобразует исходный код в бинарные файлы — фактические исполняемые файлы.

Вызов `make` обычно заключается в простом вводе команды `make`. Это, как правило, собирает все необходимые исполняемые файлы для рассматриваемого пакета. Однако `make` также может выполнять другие задачи, такие как установка файлов в соответствующие каталоги (`make install`) и удаление устаревших объектных файлов (`make clean`). Запуск `make -n` позволяет предварительно просмотреть процесс сборки, так как он выводит все команды, которые были бы выполнены при запуске `make`, без их фактического выполнения.

Только самое простое программное обеспечение использует общий (generic) `Makefile`. Более сложные установки требуют настройки `Makefile` в соответствии с расположением библиотек, заголовочных файлов и ресурсов на вашем конкретном компьютере. Это особенно актуально, когда для сборки требуются библиотеки X11. С этой задачей справляются `Imake` и `xmkmf`.

`Imakefile`, если цитировать man-страницу, является «шаблоном» `Makefile`. Утилита `imake` создает `Makefile`, подходящий для вашей системы, из `Imakefile`. Однако почти во всех случаях вы будете запускать `xmkmf` — скрипт, который вызывает `imake`, являющийся его фронтендом. Проверьте файлы `README` или `INSTALL`, входящие в архив программного обеспечения, для получения конкретных инструкций. (Если после распаковки исходных файлов в базовом каталоге присутствует файл `Imake`, это верный признак того, что нужно запустить `xmkmf`.) Прочтите man-страницы `Imake` и `xmkmf` для более подробного анализа процедуры.

Имейте в виду, что `xmkmf` и `make` может потребоваться запускать от имени root, особенно при выполнении `make install` для перемещения бинарных файлов в каталоги `/usr/bin` или `/usr/local/bin`. Использование `make` как обычного пользователя без прав root, скорее всего, приведет к сообщениям об ошибках отказа в доступе на запись, потому что у вас нет разрешения на запись в системные каталоги. Также проверьте, что созданные бинарные файлы имеют соответствующие права на выполнение для вас и любых других соответствующих пользователей.

Вызов `xmkmf` использует файл `Imake` для создания нового `Makefile`, подходящего для вашей системы. Обычно вы вызываете `xmkmf` с аргументом `-a`, чтобы автоматически выполнить `make Makefiles`, `make includes` и `make depend`. Это устанавливает переменные и определяет расположение библиотек для компилятора и компоновщика. Иногда файла `Imake` не будет, вместо него будет скрипт `INSTALL` или `configure`, который выполнит эту цель. Обратите внимание, что если вы запускаете `configure`, его следует вызывать как `./configure`, чтобы убедиться, что вызывается правильный скрипт `configure` в текущем каталоге. В большинстве случаев файл `README`, входящий в дистрибутив, объяснит процедуру установки.

Обычно рекомендуется визуально проверить `Makefile`, который создает `xmkmf` или один из установочных скриптов. `Makefile` обычно будет правильным для вашей системы, но иногда вам может потребоваться «подправить» его или исправить ошибки вручную.

Установка свежесобранных бинарных файлов в соответствующие системные каталоги обычно осуществляется запуском `make install` от имени root. Обычными каталогами для системных бинарных файлов в современных дистрибутивах Linux являются `/usr/bin`, `/usr/X11R6/bin` и `/usr/local/bin`. Предпочтительным каталогом для новых пакетов является `/usr/local/bin`, так как это позволит отделить бинарные файлы, не входящие в оригинальную установку Linux.

Пакеты, изначально предназначенные для коммерческих версий UNIX, могут пытаться установиться в `/opt` или другой незнакомый каталог. Это, конечно, приведет к ошибке установки, если целевой каталог установки не существует. Простейший способ справиться с этим — создать, как root, каталог `/opt`, позволить пакету установиться туда, а затем добавить этот каталог в переменную окружения `PATH`. Альтернативно, вы можете создать символические ссылки в каталоге `/usr/local/bin`.

Таким образом, общая процедура установки будет следующей:

1. Прочтите файл `README` и другую применимую документацию.

2. Запустите `xmkmf -a`, или скрипт `INSTALL`, или `configure`.

3. Проверьте `Makefile`.

4. При необходимости запустите `make clean`, `make Makefiles`, `make includes` и `make depend`.

5. Запустите `make`.

6. Проверьте права доступа к файлам.

7. При необходимости запустите `make install`.

Примечания:

- Обычно вы не собираете пакет как root. Необходимость в `su` до root возникает только для установки скомпилированных бинарных файлов в системные каталоги.

- После ознакомления с `make` и его использованием вы, возможно, захотите добавить дополнительные опции оптимизации, передаваемые `gcc`, в стандартный `Makefile`, включенный в пакет или созданный в нем. Некоторые из этих общих опций: `-O2`, `-fomit-frame-pointer`, `-funroll-loops` и `-mpentium` (если у вас процессор Pentium). Будьте осторожны и руководствуйтесь здравым смыслом при изменении `Makefile`!

- После того как `make` создаст бинарные файлы, вы можете захотеть «очистить» их (strip). Команда `strip` удаляет символическую отладочную информацию из бинарных файлов и уменьшает их размер, часто значительно. Это, конечно, также отключает возможность отладки.

- Проект Pack Distribution предлагает другой подход к созданию архивов программных пакетов, основанный на наборе инструментов скриптинга на Python для управления символическими ссылками на файлы, установленные в отдельных коллекционных каталогах. Эти архивы представляют собой обычные тарболлы, но они устанавливаются в каталоги `/coll` и `/pack`. Вам может понадобиться загрузить Pack-Collection с указанного выше сайта, если вы столкнетесь с одним из таких дистрибутивов.

---
[[Навигация по книге «Building and Installing Software Packages for Linux»]]


### Зачем вам это нужно? Развёрнутые пояснения

Эта глава вводит несколько ключевых концепций, которые являются основополагающими для процесса сборки программного обеспечения в Linux. Давайте разберем их по пунктам.

**1. Makefile — это скрипт сборки.**

- `Makefile` содержит правила, которые описывают, как получить конечные продукты (исполняемые файлы, библиотеки) из исходного кода. Каждое правило состоит из цели (target), зависимостей и команд.

- В LFS вы будете следовать инструкциям, которые часто говорят: `make`, `make install`. Понимание того, что эти команды делают (а они читают `Makefile` и выполняют указанные там действия), очень важно.

**2. Цепочка инструментов (toolchain): препроцессор, компилятор, линкер.**

- Когда `Makefile` запускает `gcc`, на самом деле происходит несколько этапов. Например, для сборки программы на C:

    1. Препроцессор обрабатывает директивы `#include` и `#define`.
    
    2. Компилятор преобразует исходный код на C в ассемблерный код.
    
    3. Ассемблер преобразует ассемблерный код в объектные файлы (машинный код).
    
    4. Линкер связывает объектные файлы с библиотеками, создавая исполняемый файл.

- В LFS вы будете собирать цепочку инструментов (toolchain) дважды: сначала временную, которая будет изолирована от хостовой системы, а затем окончательную. Понимание этих этапов поможет вам отлаживать проблемы.

**3. Разные способы конфигурации: Imake, xmkmf, configure.**

- В старых пакетах, особенно тех, что используют X11, часто используется `Imake` и `xmkmf`. Сегодня большинство пакетов используют скрипт `configure`.

- Скрипт `configure` проверяет вашу систему на наличие необходимых библиотек, заголовочных файлов и других зависимостей, а затем генерирует `Makefile`, подходящий для вашей системы.

- В LFS вы будете часто запускать `./configure` с множеством параметров (таких как `--prefix=/usr`). Понимание того, что `configure` настраивает `Makefile`, поможет вам понять, почему эти параметры важны.

**4. Права доступа и установка.**

- Очень важно различать этап сборки (который можно выполнять от обычного пользователя) и этап установки (который требует прав root, так как происходит копирование файлов в системные каталоги).

- В LFS вы будете выполнять сборку от имени непривилегированного пользователя (кроме определенных этапов), а установку — от root, но внутри изолированного окружения (chroot). Это важно для безопасности и стабильности.

**5. Оптимизация и отладка.**

- Вы можете модифицировать `Makefile`, чтобы добавить флаги оптимизации (например, `-O2`). Однако в LFS вы будете использовать заранее заданные флаги, которые указаны в книге LFS, чтобы обеспечить стабильность системы.

- Команда `strip` удаляет отладочную информацию, уменьшая размер исполняемых файлов. В LFS это делается для некоторых пакетов, чтобы сэкономить место.

**6. Общая процедура установки.**

- Автор приводит пошаговую процедуру, которая является универсальной. В LFS вы будете следовать аналогичным шагам для каждого пакета:

    1. Распаковка.
    
    2. Конфигурация (запуск `configure` или аналогичного скрипта).
    
    3. Сборка (`make`).
    
    4. Установка (`make install`).
    
    5. Очистка (удаление временных файлов).

**Практический совет для тренировки перед LFS:**

1. Возьмите пакет, который использует `configure` (например, `wget`).

2. Распакуйте его.

3. Вместо того чтобы сразу запускать `./configure`, попробуйте запустить `./configure --help` и изучите доступные опции.

4. Запустите `./configure` с несколькими опциями (например, `--prefix=$HOME/test_install`).

5. Выполните `make`, затем `make install` (в данном случае без root, так как вы устанавливаете в свой домашний каталог).

6. Проверьте, что бинарные файлы появились в `$HOME/test_install/bin`.

**Итог главы:** `make` — это инструмент, который управляет процессом сборки. Понимание того, как он работает, как генерируется `Makefile` (через `configure`, `xmkmf` и т.д.) и как правильно выполнять сборку и установку, является ключевым для успешного прохождения LFS. Вы учитесь не просто вводить команды, а понимать, что происходит за кулисами. Это превращает вас из пользователя в системного администратора и разработчика.